import{l as i,_ as u,t as D,g as B,a as w,b as H}from"./chunk-fb0ed6eb.js";import{I as E,C as R,O as $}from"./chunk-3f92e865.js";const b=["page","link","selection"],g="j2team_report_abuse",X=[{id:g,title:"Report abuse...",contexts:b},{id:"report_phishing",title:"Phishing",contexts:b,parentId:g},{id:"report_badware",title:"Badware",contexts:b,parentId:g},{id:"report_webspam",title:"Webspam",contexts:b,parentId:g}],V=[{id:"tools",title:"Tools",contexts:["browser_action"]},{id:"custom_blocklist",title:"Custom Blocklist",contexts:["browser_action"],parentId:"tools"}],d="j2team_google_shortcuts",K=[{id:d,title:"Google Shortcuts",type:"normal"},{id:"google_doc",title:"New Doc",type:"normal",parentId:d},{id:"google_sheet",title:"New Sheet",type:"normal",parentId:d},{id:"google_slide",title:"New Slide",type:"normal",parentId:d},{id:"google_form",title:"New Form",type:"normal",parentId:d},{id:"google_site",title:"New Site",type:"normal",parentId:d},{id:"google_keep",title:"New Keep",type:"normal",parentId:d},{id:"google_cal",title:"New Calendar",type:"normal",parentId:d}],W=(t,o)=>{let r=t.pageUrl||t.linkUrl||t.selectionText||o.url||"";if(typeof t.selectionText=="string"){r.startsWith("http")||(r=`http://${r}`);try{var e=new URL(r).hostname;!e.includes(".")&&e!=="localhost"&&(r=t.pageUrl||o.url||"")}catch{r=t.pageUrl||o.url||""}}return r},J=["junookyo.com",".junookyo.com","junookyo.blogspot.com","junookyo.blogspot.","j2team.dev","j2team.org","google.com","facebook.com","youtube.com","wikipedia.org"],N=t=>{if(typeof t!="string"||t.startsWith("chrome:")||t.startsWith("file:")||t.startsWith("about:")||t.includes("/safebrowsing/report")||t.includes("/search-console/report"))return!1;try{let o=new URL(t),r=o.protocol;if(r==="chrome:"||r==="file:"||r==="about:")return!1;let e=o.hostname,n=!0;return J.forEach(a=>{(e===a||e.includes(a))&&(n=!1)}),n}catch{return!1}},G=(t,o)=>{let r=W(t,o);if(!N(r))return;switch(r=encodeURIComponent(r),t.menuItemId.toString()){case"report_phishing":u(`https://safebrowsing.google.com/safebrowsing/report_phish/?url=${r}&utm_source=extension&utm_medium=j2team_security`);break;case"report_badware":u(`https://safebrowsing.google.com/safebrowsing/report_badware/?url=${r}&utm_source=extension&utm_medium=j2team_security`);break;case"report_webspam":u(`https://www.google.com/webmasters/tools/spamreportform?spamurl=${r}&utm_source=extension&utm_medium=j2team_security`);break}},Y=()=>{chrome.contextMenus.onClicked.addListener((t,o)=>{const r=t.menuItemId.toString();if(r==="custom_blocklist"&&u(chrome.runtime.getURL("options.html")),r.startsWith("google_")&&r!==d&&u(`https://${r.substr(7)}.new/`),r==="j2team_scan_with_virustotal"&&t.linkUrl){const e=t.linkUrl;if(/^https?:\/\/(www.)?virustotal.com/.test(e))return;const n=encodeURIComponent(encodeURIComponent(e));u(`https://www.virustotal.com/gui/search/${n}`)}r==="j2team_toggle_password_fields"&&o&&o.id&&chrome.scripting.executeScript({target:{tabId:o.id},func:D}),r==="j2team_toggle_design_mode"&&o&&o.id&&chrome.scripting.executeScript({target:{tabId:o.id},func:()=>{document.body.contentEditable=document.body.contentEditable==="true"?"false":"true",document.designMode=document.designMode==="on"?"off":"on"}}),r.startsWith("report_")&&o&&G(t,o)})},L=t=>{chrome.contextMenus.update(g,{enabled:t===void 0?!1:N(t)})},z=()=>{chrome.tabs.onUpdated.addListener((t,o,r)=>{o.status==="loading"&&L(o.url)}),chrome.tabs.onActivated.addListener(t=>{chrome.tabs.get(t.tabId,o=>{L(o.url)})})},Q=()=>{X.forEach(t=>{chrome.contextMenus.create(t)}),V.forEach(t=>{chrome.contextMenus.create(t)}),K.forEach(t=>{chrome.contextMenus.create(t)}),chrome.contextMenus.create({id:"j2team_scan_with_virustotal",title:"Scan with VirusTotal",contexts:["link"]}),chrome.contextMenus.create({type:"normal",title:"Toggle Password Fields",id:"j2team_toggle_password_fields",contexts:["page","editable"]}),chrome.contextMenus.create({type:"normal",title:"Toggle Design-Mode",id:"j2team_toggle_design_mode",contexts:["page","editable"]}),Y(),z(),i("Context menus registered")},h={J2TEAM_ORG:1,FACEBOOK:2,FACEBOOK_PIXEL:3,LOCALHOST:4};class U{static get(o){return new Promise((r,e)=>{chrome.storage.local.get(o,n=>{if(chrome.runtime.lastError)e(chrome.runtime.lastError);else{const a=n[o];a&&a.expirationTime&&a.expirationTime<Date.now()?chrome.storage.local.remove(o,()=>{r(null)}):r(a?a.value:null)}})})}static set(o,r,e){return new Promise((n,a)=>{const c=Date.now()+e*60*1e3,s={value:r,expirationTime:c};chrome.storage.local.set({[o]:s},()=>{chrome.runtime.lastError?a(chrome.runtime.lastError):n()})})}}const S=async()=>{const t=await T();if(!t)return null;const o=await U.get(`fb_dtsg_${t}`);if(o)return i("return cached fb_dtsg"),o;try{const e=await(await fetch("https://mbasic.facebook.com/photos/upload/",{credentials:"include"})).text();if(e.includes("fast_switch_site")){const a=/"(https:\/\/m\.facebook\.com\/a\/preferences\.php\?fast_switch_site[a-zA-Z0-9&=\-_%.;]+)"/.exec(e);return a!==null?(await(await fetch(a[1],{credentials:"include"})).text(),await S()):null}else{const n=B(e,'name="fb_dtsg" value="','" ');return n?(i("cache fb_dtsg"),await U.set(`fb_dtsg_${t}`,n,15),n):null}}catch(r){return w(r.message),null}},T=async()=>{const t=await chrome.cookies.get({url:"https://www.facebook.com",name:"c_user"});return t?t.value:null},O=async t=>{const o=await S();if(!o)return{error:!0};let r=`fb_dtsg=${encodeURIComponent(o)}`;t.includes("variables")?r+=`&${t}`:r+=`&q=${encodeURIComponent(t)}`;try{return await(await fetch("https://www.facebook.com/api/graphql/",{body:r,method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},credentials:"include"})).json()}catch{return{error:!0}}},x=async(t=null,o=!1)=>{t||(t="https://adsmanager.facebook.com/adsmanager/manage/campaigns");const e=await(await fetch(t,{method:"GET",credentials:"include"})).text(),n=e.match(/window\.__accessToken="([^"]+)"/);if(n!==null)return n[1];if(t.includes("act=")&&!o)return null;const a=e.match(/campaigns\?act=([0-9]+)&/);return a!=null?(t=`https://adsmanager.facebook.com/adsmanager/manage/campaigns?nav_source=no_referrer&breakdown_regrouping=1&act=${a[1]}`,await x(t,!0)):null},C={type:chrome.declarativeNetRequest.RuleActionType.MODIFY_HEADERS,requestHeaders:[{operation:chrome.declarativeNetRequest.HeaderOperation.SET,header:"J2TEAM-Security-ID",value:chrome.runtime.id},{operation:chrome.declarativeNetRequest.HeaderOperation.SET,header:"J2TEAM-Security-Version",value:chrome.runtime.getManifest().version}]},Z={urlFilter:"j2team.org",resourceTypes:[chrome.declarativeNetRequest.ResourceType.MAIN_FRAME,chrome.declarativeNetRequest.ResourceType.SUB_FRAME,chrome.declarativeNetRequest.ResourceType.XMLHTTPREQUEST]},j=[{id:h.J2TEAM_ORG,priority:1,action:C,condition:Z},{id:h.FACEBOOK,priority:1,action:{type:chrome.declarativeNetRequest.RuleActionType.MODIFY_HEADERS,requestHeaders:[{operation:chrome.declarativeNetRequest.HeaderOperation.SET,header:"origin",value:"https://www.facebook.com"},{operation:chrome.declarativeNetRequest.HeaderOperation.SET,header:"referer",value:"https://www.facebook.com"}]},condition:{regexFilter:"^https://(www|m|mbasic)\\.facebook\\.com/.*"}}];E||j.push({id:h.LOCALHOST,priority:1,action:C,condition:{urlFilter:"localhost",resourceTypes:[chrome.declarativeNetRequest.ResourceType.MAIN_FRAME,chrome.declarativeNetRequest.ResourceType.SUB_FRAME,chrome.declarativeNetRequest.ResourceType.XMLHTTPREQUEST]}});const ee=async()=>{try{const o=(await chrome.declarativeNetRequest.getDynamicRules()).map(r=>r.id);chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:o,addRules:j})}catch{}},te=()=>Math.floor(Math.random()*1e14).toString().substr(0,12),oe=()=>{var o,r;const t=(r=(o=chrome.runtime.getManifest().externally_connectable)==null?void 0:o.matches)==null?void 0:r.map(e=>new URL(e).hostname);t&&chrome.runtime.onMessageExternal.addListener(async(e,n,a)=>{if(!n.url)return;const c=new URL(n.url).hostname;if(!t.includes(c)){w(`Message from ${c} is not allowed`);return}let s=e.cmd.toLowerCase();switch(i(s),s){case"web_auth":const m=await T();if(!m){a({uid:null});return}if(e.uid_only){a({uid:m});return}const k=te(),f=H(`${k}${m.split("").reverse().join("")}`);if(!f){a({uid:m});return}const q=E?"https://j2team.dev/extension/auth":"http://j2team.test/extension/auth";try{const _=await(await fetch(q,{headers:{"j2team-security-auth":f}})).json();a({uid:m,data:_})}catch{a({uid:m})}break;case"request_http":try{const l=await fetch(e.resource,e.init),_=e.json?await l.json():await l.text();a(_)}catch(l){a({success:!1,error:l.message})}break;case"get_options":chrome.storage.sync.get(null,a);break;case"set_options":chrome.storage.sync.set(e.options,a);break;case"create_tab":u(e.url);break;case"open_extension_page":u(chrome.runtime.getURL(e.path));break;case"create_notification":chrome.notifications.create(e.id,e.options,a);break;case"request_graphql":O(e.query).then(a);break;case"kount":O("viewer(){message_threads{count,nodes{customization_info{emoji,outgoing_bubble_color,participant_customizations{participant_id,nickname}},all_participants{nodes{messaging_actor{name,id,profile_picture}}},thread_type,name,messages_count,image,id}}}").then(a);break;case"fbinit":const v=await T();if(!v){a({uid:null,token:null});return}const F=await S();a({uid:v,token:F||null});break;case"request_graph_api":if(!e.endpoint)break;const M=await x();if(!M){a({success:!1,error:!0});return}try{const l=await fetch(e.endpoint.replace("__TOKEN__",M),{method:e.method||"GET"});a(await l.json())}catch(l){a({success:!1,error:!0,error_message:l.message})}break;case"download_video":if(!e.endpoint)break;const P=await x();try{const _=await(await fetch(e.endpoint.replace("__VIDEO_ID__",e.videoId).replace("__TOKEN__",P))).json();a(_)}catch(l){a({success:!1,error:l.message})}break;case"update_fb_origin":a({success:!0});break}})},A=async t=>{const o=t?chrome.declarativeNetRequest.RuleActionType.BLOCK:chrome.declarativeNetRequest.RuleActionType.ALLOW;i("start update net request rules: block Facebook Pixel",{action:o});const r=await chrome.declarativeNetRequest.getDynamicRules(),e={addRules:[{id:h.FACEBOOK_PIXEL,priority:1,action:{type:o},condition:{urlFilter:"https://connect.facebook.net/*/fbevents.js*"}}]};r.some(n=>n.id===h.FACEBOOK_PIXEL)&&(i("Need to remove old rule!"),e.removeRuleIds=[h.FACEBOOK_PIXEL]);try{await chrome.declarativeNetRequest.updateDynamicRules(e),i("update net request rules: block Facebook Pixel success")}catch(n){w("Error:",n)}},re=()=>{if(window.J2TEAM_SECURITY)return;window.J2TEAM_SECURITY=!0;const t=window.XMLHttpRequest;window.XMLHttpRequest=new Proxy(t,{construct(o,r){const e=new o(...r),n=e.open;e.open=function(c,s,m,k,f){return this._method=c,this._url=s,n.apply(this,arguments)};const a=e.send;return e.send=function(c){if(!(this._method==="POST"&&c&&c.toString().includes("storiesUpdateSeenStateMutation")))return a.apply(this,arguments)},e}})},y=(t,o,r)=>{var e;(e=r.url)!=null&&e.includes(".facebook.com/")&&(i("Tab updated",r.url),chrome.scripting.executeScript({target:{tabId:t},func:re,world:"MAIN"}))},ae=()=>{if(window.J2TEAM_SECURITY)return;window.J2TEAM_SECURITY=!0;const t=window.XMLHttpRequest;window.XMLHttpRequest=new Proxy(t,{construct(o,r){const e=new o(...r),n=e.open;e.open=function(c,s,m,k,f){return this._method=c,this._url=s,n.apply(this,arguments)};const a=e.send;return e.send=function(c){if(this._method==="POST"&&c){const s=c.toString();if(s.includes("SeenMutation")||s.includes("SeenDirectMutation")){i("Blocked seen story");return}}return a.apply(this,arguments)},e}})},I=(t,o,r)=>{var e;(e=r.url)!=null&&e.includes(".instagram.com/")&&(i("Tab updated",r.url),chrome.scripting.executeScript({target:{tabId:t},func:ae,world:"MAIN"}))},ne=()=>{chrome.runtime.onMessage.addListener(async(t,o,r)=>{if(t.cmd==="block_page"){const e=o.tab;if(!e||!e.id||!(await chrome.storage.sync.get({realtime:!0})).realtime)return;const a=e.url;a&&chrome.tabs.update(e.id,{url:chrome.runtime.getURL(`blocked.html?url=${encodeURIComponent(a)}`),active:!0,highlighted:!0})}if(t.cmd==="continue_to_site"){const e=await chrome.storage.local.get("bypass_token");if(!e||!e.bypass_token)return;const n=o.tab;if(!n||!n.id)return;const a=n.url;if(!a)return;let s=new URLSearchParams(a.split("?")[1]).get("url");if(!s)return;s.includes("?")?s+="&":s+="?",s+="jstk="+encodeURIComponent(e.bypass_token),chrome.tabs.update(n.id,{url:s,active:!0,highlighted:!0}),chrome.alarms.create("remove_bypass_token",{delayInMinutes:5})}}),chrome.alarms.onAlarm.addListener(t=>{t.name==="remove_bypass_token"&&chrome.storage.local.remove("bypass_token")})},se=chrome.runtime.getURL("img/juno_okyo.png");chrome.runtime.onInstalled.addListener(async t=>{switch(t.reason){case chrome.runtime.OnInstalledReason.INSTALL:u(R.url.welcome),chrome.storage.sync.set({install_date:new Date().getTime()});break;case chrome.runtime.OnInstalledReason.UPDATE:const o=await chrome.storage.sync.get({show_update_notification:!0,install_date:null});if(o.install_date===null&&chrome.storage.sync.set({install_date:new Date().getTime()}),o.show_update_notification){const r=chrome.i18n.getMessage("updateMessage").replace("{appName}",chrome.i18n.getMessage("appName")).replace("{appVersion}",chrome.runtime.getManifest().version);chrome.notifications.create("extension_updated",{type:"basic",iconUrl:se,title:chrome.i18n.getMessage("appName"),message:r,isClickable:!0},e=>{e==="extension_updated"&&chrome.notifications.onClicked.addListener(async n=>{n===e&&(await u(R.url.changelog),chrome.notifications.clear(n))})})}break}Q(),ne();try{chrome.webRequest.onActionIgnored.addListener(o=>{i("onActionIgnored",o)})}catch(o){w("onActionIgnored error",o)}});E&&chrome.runtime.setUninstallURL(R.url.uninstall);ee();oe();const p={account_type:"free",anti_clickjacking:!0,block_crypto_currency_mining:!0,block_facebook_pixel:!1,block_seen_chat:!1,block_seen_story_facebook:!1,block_seen_story_instagram:!1,block_typing_chat:!1,realtime:!0,remove_fbclid:!1,show_update_notification:!0,show_facebook_time_counter:!1};chrome.storage.sync.get($,t=>{Object.assign(p,t),i("Options loaded",p),i("Applying options..."),A(p.block_facebook_pixel),p.block_seen_story_facebook&&chrome.tabs.onUpdated.addListener(y),p.block_seen_story_instagram&&chrome.tabs.onUpdated.addListener(I),chrome.storage.onChanged.addListener(async(o,r)=>{if(r==="sync"){i("Options changed",o);for(const e in o)p[e]=o[e].newValue;o.block_facebook_pixel&&(i("Block Facebook Pixel changed",o.block_facebook_pixel.newValue),await A(o.block_facebook_pixel.newValue)),o.block_seen_story_facebook&&(i("Block seen story Facebook changed",o.block_seen_story_facebook.newValue),o.block_seen_story_facebook.newValue?chrome.tabs.onUpdated.addListener(y):chrome.tabs.onUpdated.removeListener(y)),o.block_seen_story_instagram&&(i("Block seen story Instagram changed",o.block_seen_story_instagram.newValue),o.block_seen_story_instagram.newValue?chrome.tabs.onUpdated.addListener(I):chrome.tabs.onUpdated.removeListener(I))}})});
